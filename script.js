var DECADES = [
  {
    id:'1970s',
    items:[
      {year:'1975',desc:'On July 24, Giorgio Armani founds his brand in Milan, together with Sergio Galeotti. It is the beginning of a stylistic revolution destined to redefine the way we conceive clothing.',credit:'Giorgio Armani logo, designed by Flavio Lucchini, used on labels from 1976 to the mid-1980s',img:'https://picsum.photos/seed/a70a/800/1000'},
      {year:'1976',desc:'The first Giorgio Armani womenswear collection is presented in Milan.',credit:'Giorgio Armani womenswear debut, Milan, 1976',img:'https://picsum.photos/seed/a70b/800/1000'},
      {year:'1977',desc:'Armani expands the brand with the launch of a ready-to-wear line.',credit:'Armani ready-to-wear presentation, Milan Fashion Week, 1977',img:'https://picsum.photos/seed/a70c/800/1000'},
      {year:'1978',desc:'The brand introduces a fragrance line.',credit:'Armani fragrance campaign, 1978',img:'https://picsum.photos/seed/a70d/800/1000'},
      {year:'1979',desc:'International press begins to take notice of the Italian designer.',credit:'International fashion press coverage, 1979',img:'https://picsum.photos/seed/a70e/800/1000'},
      {year:'1979',desc:'Giorgio Armani receives his first Neiman Marcus Fashion Award.',credit:'Neiman Marcus Fashion Award ceremony, 1979',img:'https://picsum.photos/seed/a70f/800/1000'}
    ]
  },
  {
    id:'1980s',
    items:[
      {year:'1980',desc:'Richard Gere wears Giorgio Armani in American Gigolo.',credit:'Richard Gere in American Gigolo, Paramount Pictures, 1980',img:'https://picsum.photos/seed/a80a/800/1000'},
      {year:'1982',desc:'Giorgio Armani appears on the cover of TIME magazine.',credit:'TIME Magazine cover, April 5, 1982.',img:'https://picsum.photos/seed/a80b/800/1000'},
      {year:'1983',desc:'The Emporio Armani line is launched.',credit:'Emporio Armani launch campaign, 1983',img:'https://picsum.photos/seed/a80c/800/1000'},
      {year:'1985',desc:'Armani dresses numerous Hollywood stars for the Academy Awards.',credit:'Academy Awards ceremony, Hollywood, 1985',img:'https://picsum.photos/seed/a80d/800/1000'},
      {year:'1986',desc:'A/X Armani Exchange debuts.',credit:'A/X Armani Exchange flagship opening, 1986',img:'https://picsum.photos/seed/a80e/800/1000'},
      {year:'1989',desc:'Giorgio Armani opens a flagship store on Madison Avenue.',credit:'Madison Avenue flagship store, New York, 1989',img:'https://picsum.photos/seed/a80f/800/1000'}
    ]
  },
  {
    id:'1990s',
    items:[
      {year:'1990',desc:'With Giorgio Armani: Images of Man, the first fifteen years of Armani menswear are analyzed.',credit:'Cover of the book Images of men, published by Rizzoli',img:'https://picsum.photos/seed/a90a/800/1000'},
      {year:'1992',desc:'Armani Casa is launched.',credit:'Armani Casa collection launch, Milan, 1992',img:'https://picsum.photos/seed/a90b/800/1000'},
      {year:'1994',desc:'A major exhibition at the Royal Academy of Arts in London.',credit:'Exhibition at the Royal Academy of Arts, London, 1994',img:'https://picsum.photos/seed/a90c/800/1000'},
      {year:'1996',desc:'Armani designs costumes for The English Patient.',credit:'The English Patient, Miramax Films, 1996',img:'https://picsum.photos/seed/a90d/800/1000'},
      {year:'1997',desc:'CFDA International Award.',credit:'CFDA International Award ceremony, New York, 1997',img:'https://picsum.photos/seed/a90e/800/1000'},
      {year:'1999',desc:'Global presence consolidates.',credit:'Armani global store network, 1999',img:'https://picsum.photos/seed/a90f/800/1000'}
    ]
  },
  {
    id:'2000s',
    items:[
      {year:'2000',desc:'Guggenheim Museum retrospective.',credit:'Guggenheim Museum, New York, 2000',img:'https://picsum.photos/seed/a00a/800/1000'},
      {year:'2001',desc:'Armani Teatro opens in Milan.',credit:'Armani Teatro inauguration, Milan, 2001',img:'https://picsum.photos/seed/a00b/800/1000'},
      {year:'2003',desc:'First Armani Hotel announced.',credit:'Armani Hotel project announcement, 2003',img:'https://picsum.photos/seed/a00c/800/1000'},
      {year:'2004',desc:'30th anniversary exhibition in Rome.',credit:'30th anniversary exhibition, Rome, 2004',img:'https://picsum.photos/seed/a00d/800/1000'},
      {year:'2005',desc:'Ginza Tower opens in Tokyo.',credit:'Armani Ginza Tower, Tokyo, 2005',img:'https://picsum.photos/seed/a00e/800/1000'},
      {year:'2007',desc:'Armani Prive nightclub opens.',credit:'Armani Prive, Milan, 2007',img:'https://picsum.photos/seed/a00f/800/1000'},
      {year:'2009',desc:'Global corporate structure consolidated.',credit:'Armani corporate headquarters, Milan, 2009',img:'https://picsum.photos/seed/a00g/800/1000'}
    ]
  },
  {
    id:'2010s',
    items:[
      {year:'2010',desc:'Armani Hotel Dubai opens in the Burj Khalifa.',credit:'Armani Hotel Dubai, Burj Khalifa, 2010',img:'https://picsum.photos/seed/a10a/800/1000'},
      {year:'2011',desc:'La Femme Bleue collection.',credit:'Spring-Summer 2011 Womenswear collection',img:'https://picsum.photos/seed/a10b/800/1000'},
      {year:'2013',desc:'BFC Lifetime Achievement Award.',credit:'BFC Lifetime Achievement Award, London, 2013',img:'https://picsum.photos/seed/a10c/800/1000'},
      {year:'2015',desc:'Armani/Silos museum opens.',credit:'Armani/Silos museum opening, Milan, 2015',img:'https://picsum.photos/seed/a10d/800/1000'},
      {year:'2016',desc:'Digital presence evolves.',credit:'Armani digital campaign, 2016',img:'https://picsum.photos/seed/a10e/800/1000'},
      {year:'2019',desc:'Commitment to sustainability.',credit:'Armani sustainability announcement, Milan, 2019',img:'https://picsum.photos/seed/a10f/800/1000'}
    ]
  },
  {
    id:'2020s',
    items:[
      {year:'2020',desc:'Collection presented in an empty theater during the pandemic.',credit:'Armani show, Milan Fashion Week, 2020',img:'https://picsum.photos/seed/a20a/800/1000'},
      {year:'2021',desc:'Giorgio Armani per Amore initiative launched.',credit:'Giorgio Armani per Amore initiative, 2021',img:'https://picsum.photos/seed/a20b/800/1000'},
      {year:'2023',desc:'The Armani archive continues to expand.',credit:'Armani retrospective exhibition, 2023',img:'https://picsum.photos/seed/a20c/800/1000'}
    ]
  }
];

var MODES = ['light','dark','system'];

var state = {
  currentDecade:0,
  currentItem:0,
  dropdownOpen:false,
  modeOpen:false,
  mobileMenuOpen:false,
  visibleDecade:0,
  themeMode:'light'
};

function thumbUrl(decadeIdx,itemIdx){
  return 'https://picsum.photos/seed/t'+decadeIdx+'-'+itemIdx+'/400/500';
}

function applyTheme(mode){
  state.themeMode=mode;
  var body=document.body;

  if(mode==='dark'){
    body.classList.add('dark');
  } else if(mode==='system'){
    var prefersDark=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
    if(prefersDark){
      body.classList.add('dark');
    } else {
      body.classList.remove('dark');
    }
  } else {
    body.classList.remove('dark');
  }

  updateModeDropdown();
}

function updateModeDropdown(){
  var options=document.querySelectorAll('.mode-option');
  options.forEach(function(opt){
    if(opt.getAttribute('data-mode')===state.themeMode){
      opt.classList.add('active');
    } else {
      opt.classList.remove('active');
    }
  });
}

function renderModeDropdown(){
  var el=document.getElementById('modeDropdown');
  var html='';
  MODES.forEach(function(m){
    html+='<div class="mode-option'+(m===state.themeMode?' active':'')+'" data-mode="'+m+'">'+m+'</div>';
  });
  el.innerHTML=html;
  el.querySelectorAll('.mode-option').forEach(function(opt){
    opt.addEventListener('click',function(e){
      e.stopPropagation();
      var mode=this.getAttribute('data-mode');
      applyTheme(mode);
      state.modeOpen=false;
      document.getElementById('modeBtn').className='mode-btn';
      document.getElementById('modeDropdown').className='mode-dropdown';
    });
  });
}

function renderDecadeDropdown(){
  var el=document.getElementById('decadeDropdown');
  var html='';
  DECADES.forEach(function(d,i){
    html+='<div class="decade-option'+(i===state.currentDecade?' active':'')+'" data-idx="'+i+'">'+d.id+'</div>';
  });
  el.innerHTML=html;
  el.querySelectorAll('.decade-option').forEach(function(opt){
    opt.addEventListener('click',function(){
      state.currentDecade=parseInt(this.getAttribute('data-idx'));
      state.currentItem=0;
      state.dropdownOpen=false;
      render();
      scrollToDecadeSection(state.currentDecade);
    });
  });
}

function scrollToDecadeSection(idx){
  var section=document.querySelector('[data-decade-section="'+idx+'"]');
  if(section){
    var stickyHeight=document.getElementById('decadeHeaderSticky').offsetHeight;
    var container=document.getElementById('pageBody');
    var offset;
    if(window.innerWidth>768){
      offset=section.offsetTop-stickyHeight;
      container.scrollTo({top:offset,behavior:'smooth'});
    } else {
      offset=section.getBoundingClientRect().top+window.scrollY-stickyHeight-60;
      window.scrollTo({top:offset,behavior:'smooth'});
    }
  }
}

function renderThumbnails(){
  var area=document.getElementById('thumbsArea');
  var html='';
  DECADES.forEach(function(d,di){
    html+='<div class="decade-section" data-decade-section="'+di+'">';
    html+='<div class="decade-section-label">'+d.id+'</div>';
    html+='<div class="thumb-grid">';
    d.items.forEach(function(item,ii){
      var active=(di===state.currentDecade&&ii===state.currentItem)?' active':'';
      html+='<div class="thumb-cell'+active+'" data-d="'+di+'" data-i="'+ii+'">';
      html+='<img src="'+thumbUrl(di,ii)+'" alt="'+d.id+' - '+item.year+'" loading="lazy">';
      html+='</div>';
    });
    html+='</div></div>';
  });
  area.innerHTML=html;
  area.querySelectorAll('.thumb-cell').forEach(function(cell){
    cell.addEventListener('click',function(){
      var di=parseInt(this.getAttribute('data-d'));
      var ii=parseInt(this.getAttribute('data-i'));
      state.currentDecade=di;
      state.currentItem=ii;
      if(window.innerWidth<=768){
        showMobileDetail(di,ii);
      } else {
        updateActiveThumb();
        renderDetail();
      }
    });
  });
}

function updateActiveThumb(){
  document.querySelectorAll('.thumb-cell').forEach(function(cell){
    var di=parseInt(cell.getAttribute('data-d'));
    var ii=parseInt(cell.getAttribute('data-i'));
    if(di===state.currentDecade&&ii===state.currentItem){
      cell.classList.add('active');
    } else {
      cell.classList.remove('active');
    }
  });
}

function renderDetail(){
  var d=DECADES[state.currentDecade];
  var item=d.items[state.currentItem];
  document.getElementById('detailYear').textContent=item.year;
  document.getElementById('detailDesc').textContent=item.desc;
  document.getElementById('detailCredit').textContent=item.credit;
  document.getElementById('featuredImg').src=item.img;
  document.getElementById('featuredImg').alt=d.id+' - '+item.year;
}

function updateStickyDecadeTitle(){
  var sections=document.querySelectorAll('[data-decade-section]');
  var stickyEl=document.getElementById('decadeHeaderSticky');
  var stickyBottom=stickyEl.getBoundingClientRect().bottom;

  var currentVisibleIdx=0;
  sections.forEach(function(section){
    var rect=section.getBoundingClientRect();
    if(rect.top<stickyBottom+50){
      currentVisibleIdx=parseInt(section.getAttribute('data-decade-section'));
    }
  });

  if(currentVisibleIdx!==state.visibleDecade){
    state.visibleDecade=currentVisibleIdx;
    document.getElementById('decadeTitle').textContent=DECADES[currentVisibleIdx].id;
  }
}

function render(){
  document.getElementById('decadeTitle').textContent=DECADES[state.currentDecade].id;
  state.visibleDecade=state.currentDecade;

  var toggleEl=document.getElementById('decadeToggle');
  toggleEl.className='decade-toggle'+(state.dropdownOpen?' open':'');

  var ddEl=document.getElementById('decadeDropdown');
  ddEl.className='decade-dropdown'+(state.dropdownOpen?' open':'');

  var modeBtnEl=document.getElementById('modeBtn');
  modeBtnEl.className='mode-btn'+(state.modeOpen?' open':'');

  var modeDdEl=document.getElementById('modeDropdown');
  modeDdEl.className='mode-dropdown'+(state.modeOpen?' open':'');

  renderDecadeDropdown();
  renderModeDropdown();
  renderThumbnails();
  renderDetail();
}

function showMobileDetail(di,ii){
  var d=DECADES[di];
  var item=d.items[ii];
  var body=document.getElementById('mobileDetailBody');
  body.innerHTML='<img src="'+item.img+'" alt="'+d.id+' - '+item.year+'">'
    +'<div class="detail-year">'+item.year+'</div>'
    +'<div class="detail-desc">'+item.desc+'</div>'
    +'<div class="detail-credit">'+item.credit+'</div>';
  document.getElementById('mobileDetail').classList.add('open');
  document.body.style.overflow='hidden';
}

function closeMobileDetail(){
  document.getElementById('mobileDetail').classList.remove('open');
  document.body.style.overflow='';
}

function initSearch(){
  var link=document.getElementById('searchLink');
  var input=document.getElementById('searchInput');
  var wrap=document.getElementById('searchWrap');

  link.addEventListener('click',function(e){
    e.stopPropagation();
    link.classList.add('hidden');
    input.classList.add('active');
    input.focus();
  });

  input.addEventListener('click',function(e){
    e.stopPropagation();
  });

  document.addEventListener('click',function(e){
    if(!wrap.contains(e.target)&&input.classList.contains('active')){
      input.classList.remove('active');
      link.classList.remove('hidden');
      input.value='';
    }
  });
}

/* ── Hero Eye Morph Animation ── */
function initHeroEyeMorph() {
  var gsap = window.gsap;
  var MorphSVGPlugin = window.MorphSVGPlugin;

  if (typeof gsap === 'undefined' || typeof MorphSVGPlugin === 'undefined') {
    return;
  }

  gsap.registerPlugin(MorphSVGPlugin);

  var oSvg = document.getElementById('heroOSvg');
  var textLeft = document.getElementById('heroTextLeft');
  var textRight = document.getElementById('heroTextRight');
  var startPaths = document.getElementById('startPaths');

  if (!oSvg || !textLeft || !textRight || !startPaths) return;

  var isEye = false;
  var animating = false;
  var morphDuration = 0.6;

  // Store the original eye path BEFORE gsap.set overwrites it
  var eyeOriginalPath = document.getElementById('start0').getAttribute('d');

  // Set initial state: morph #start0 to look like the circle (#end0)
  // This makes the SVG look like the letter "o"
  gsap.set("#start0", { morphSVG: "#end0" });

  function triggerBlink(callback) {
    startPaths.classList.add('blinking');
    setTimeout(function() {
      startPaths.classList.remove('blinking');
      if (callback) callback();
    }, 400);
  }

  function morphToEye() {
    if (isEye || animating) return;
    animating = true;
    isEye = true;

    // 1. Slide text apart to give room for the eye
    textLeft.classList.add('spread');
    textRight.classList.add('spread');

    // 2. Morph from circle (o) to eye shape
    gsap.to("#start0", {
      duration: morphDuration,
      morphSVG: eyeOriginalPath,
      ease: "power3.inOut",
      onComplete: function() {
        animating = false;
        // 3. After morph completes, blink once, then morph back
        setTimeout(function() {
          triggerBlink(function() {
            setTimeout(function() {
              morphToO();
            }, 250);
          });
        }, 400);
      }
    });
  }

  function morphToO() {
    if (!isEye || animating) return;
    animating = true;

    // 1. Slide text back together AT THE SAME TIME as the morph
    textLeft.classList.remove('spread');
    textRight.classList.remove('spread');

    // 2. Morph from eye back to circle (o)
    gsap.to("#start0", {
      duration: morphDuration,
      morphSVG: "#end0",
      ease: "power3.inOut",
      onComplete: function() {
        isEye = false;
        animating = false;
      }
    });
  }

  // Repeating cycle: wait -> morph to eye -> blink -> morph back -> wait -> repeat
  function scheduleCycle() {
    setTimeout(function() {
      morphToEye();
      // Schedule next cycle after this one completes (~2.5s total)
      setTimeout(scheduleCycle, 3500);
    }, 6000);
  }

  scheduleCycle();
}

function init(){
  render();
  initSearch();
  applyTheme('light');

  if(window.matchMedia){
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',function(){
      if(state.themeMode==='system'){
        applyTheme('system');
      }
    });
  }

  var scrollTarget=document.getElementById('pageBody');

  function onScroll(){
    updateStickyDecadeTitle();
  }

  if(window.innerWidth>768){
    scrollTarget.addEventListener('scroll',onScroll,{passive:true});
  } else {
    window.addEventListener('scroll',onScroll,{passive:true});
  }

  window.addEventListener('resize',function(){
    scrollTarget.removeEventListener('scroll',onScroll);
    window.removeEventListener('scroll',onScroll);
    if(window.innerWidth>768){
      scrollTarget.addEventListener('scroll',onScroll,{passive:true});
    } else {
      window.addEventListener('scroll',onScroll,{passive:true});
    }
  });

  document.getElementById('decadeToggle').addEventListener('click',function(){
    state.dropdownOpen=!state.dropdownOpen;
    state.modeOpen=false;
    render();
  });

  document.getElementById('modeBtn').addEventListener('click',function(e){
    e.stopPropagation();
    state.modeOpen=!state.modeOpen;
    state.dropdownOpen=false;
    render();
  });

  document.getElementById('hamburgerBtn').addEventListener('click',function(){
    document.getElementById('mobileMenu').classList.add('open');
    document.body.style.overflow='hidden';
  });

  document.getElementById('mobileMenuClose').addEventListener('click',function(){
    document.getElementById('mobileMenu').classList.remove('open');
    document.body.style.overflow='';
  });

  document.getElementById('mobileDetailBack').addEventListener('click',closeMobileDetail);

  var eyeContainer=document.getElementById('logoEye');
  if(eyeContainer){
    createEyeLogo(eyeContainer,68);
  }

  /* ── Logo brand morph animation ── */
  (function(){
    var text1=document.getElementById('morphText1');
    var text2=document.getElementById('morphText2');
    var header=document.getElementById('siteHeader');
    if(!text1||!text2||!header) return;

    var morphTime=1.2;
    // progress: 0 = hidden (blank), 1 = fully revealed ("Publiceye")
    var progress=0;
    var targetProgress=0;
    var time=Date.now();
    var rafId=null;

    // text1 always = blank space, text2 always = "Publiceye"
    // We just control their opacity/blur based on progress
    text1.textContent='\u00A0';
    text2.textContent='Publiceye';

    function applyProgress(p){
      var fClamp=Math.max(p,0.001);
      var inv=Math.max(1-p,0.001);

      // text2 = "Publiceye" fades in as p goes to 1
      text2.style.filter='blur('+Math.min(8/fClamp-8,100)+'px)';
      text2.style.opacity=String(Math.pow(fClamp,0.4)*100)+'%';

      // text1 = blank fades out as p goes to 1
      text1.style.filter='blur('+Math.min(8/inv-8,100)+'px)';
      text1.style.opacity=String(Math.pow(inv,0.4)*100)+'%';
    }

    // Initial state: fully hidden
    applyProgress(0);

    function animate(){
      rafId=requestAnimationFrame(animate);

      var now=Date.now();
      var dt=(now-time)/1000;
      time=now;

      var speed=dt/morphTime;

      if(targetProgress>progress){
        progress=Math.min(progress+speed, targetProgress);
      } else {
        progress=Math.max(progress-speed, targetProgress);
      }

      applyProgress(progress);

      // Stop when we've reached the target
      if(Math.abs(progress-targetProgress)<0.001){
        progress=targetProgress;
        applyProgress(progress);
        cancelAnimationFrame(rafId);
        rafId=null;
      }
    }

    function setTarget(t){
      targetProgress=t;
      time=Date.now();
      if(!rafId){
        rafId=requestAnimationFrame(animate);
      }
    }

    header.addEventListener('mouseenter',function(){
      setTarget(1);
    });

    header.addEventListener('mouseleave',function(){
      setTarget(0);
    });
  })();
  /* ── End logo brand morph ── */

  /* ── Init hero eye morph ── */
  initHeroEyeMorph();

  document.addEventListener('click',function(e){
    if(!e.target.closest('.mode-wrap')){
      state.modeOpen=false;
      document.getElementById('modeBtn').className='mode-btn';
      document.getElementById('modeDropdown').className='mode-dropdown';
    }
    if(!e.target.closest('.decade-header')&&!e.target.closest('.decade-dropdown')){
      state.dropdownOpen=false;
      document.getElementById('decadeToggle').className='decade-toggle';
      document.getElementById('decadeDropdown').className='decade-dropdown';
    }
  });
}



document.addEventListener('DOMContentLoaded',init);
